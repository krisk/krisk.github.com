<!DOCTYPE>
<html>

<style type="text/css">

body {
  font: 100%/1.6 cambria, palatino, georgia, serif;
}

#options article {
  margin-bottom: 10px;
}

#options aside {
  font-size: 13px;
}

#resultTextAreaContainer {
  height: 300px;
  overflow-y: scroll;
  border: 1px solid black;
}

</style>

<body>

  <head>
      <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
      <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
      <script src="http://underscorejs.org/underscore-min.js"></script>
      <script>
      !function(t){function n(t,e){this.list=t,this.options=e=e||{},this.options.sort="sort"in e?e.sort:n.defaultOptions.sort,this.options.includeScore="includeScore"in e?e.includeScore:n.defaultOptions.includeScore,this.options.searchFn=e.searchFn||n.defaultOptions.searchFn,this.options.sortFn=e.sortFn||n.defaultOptions.sortFn,this.options.keys=e.keys||n.defaultOptions.keys}var e=function(t,n){if(this.options=n||{},this.options.location=n.location||e.defaultOptions.location,this.options.distance="distance"in n?n.distance:e.defaultOptions.distance,this.options.threshold="threshold"in n?n.threshold:e.defaultOptions.threshold,this.options.maxPatternLength=n.maxPatternLength||e.defaultOptions.maxPatternLength,this.pattern=n.caseSensitive?t:t.toLowerCase(),this.patternLen=t.length,this.patternLen>this.options.maxPatternLength)throw new Error("Pattern length is too long");this.matchmask=1<<this.patternLen-1,this.patternAlphabet=this._calculatePatternAlphabet()};e.defaultOptions={location:0,distance:100,threshold:.6,maxPatternLength:32},e.prototype._calculatePatternAlphabet=function(){var t={},n=0;for(n=0;n<this.patternLen;n++)t[this.pattern.charAt(n)]=0;for(n=0;n<this.patternLen;n++)t[this.pattern.charAt(n)]|=1<<this.pattern.length-n-1;return t},e.prototype._bitapScore=function(t,n){var e=t/this.patternLen,i=Math.abs(this.options.location-n);return this.options.distance?e+i/this.options.distance:i?1:e},e.prototype.search=function(t){if(t=this.options.caseSensitive?t:t.toLowerCase(),this.pattern===t)return{isMatch:!0,score:0};var n,e,i,o,s,r,a,h,p,c=t.length,l=this.options.location,u=this.options.threshold,f=t.indexOf(this.pattern,l),d=this.patternLen+c,m=1,L=[];for(-1!=f&&(u=Math.min(this._bitapScore(0,f),u),f=t.lastIndexOf(this.pattern,l+this.patternLen),-1!=f&&(u=Math.min(this._bitapScore(0,f),u))),f=-1,n=0;n<this.patternLen;n++){for(i=0,o=d;o>i;)this._bitapScore(n,l+o)<=u?i=o:d=o,o=Math.floor((d-i)/2+i);for(d=o,s=Math.max(1,l-o+1),r=Math.min(l+o,c)+this.patternLen,a=Array(r+2),a[r+1]=(1<<n)-1,e=r;e>=s;e--)if(p=this.patternAlphabet[t.charAt(e-1)],a[e]=0===n?(a[e+1]<<1|1)&p:(a[e+1]<<1|1)&p|((h[e+1]|h[e])<<1|1)|h[e+1],a[e]&this.matchmask&&(m=this._bitapScore(n,e-1),u>=m)){if(u=m,f=e-1,L.push(f),!(f>l))break;s=Math.max(1,2*l-f)}if(this._bitapScore(n+1,l)>u)break;h=a}return{isMatch:f>=0,score:m}};var i={deepValue:function(t,n){for(var e=0,n=n.split("."),i=n.length;i>e;e++){if(!t)return null;t=t[n[e]]}return t}};n.defaultOptions={id:null,caseSensitive:!1,includeScore:!1,shouldSort:!0,searchFn:e,sortFn:function(t,n){return t.score-n.score},keys:[]},n.prototype.search=function(t){var n,e,o,s,r,a=new this.options.searchFn(t,this.options),h=this.list,p=h.length,c=this.options.keys,l=c.length,u=[],f={},d=[],m=function(t,n,e){void 0!==t&&null!==t&&"string"==typeof t&&(s=a.search(t),s.isMatch&&(r=f[e],r?r.score=Math.min(r.score,s.score):(f[e]={item:n,score:s.score},u.push(f[e]))))};if("string"==typeof h[0])for(var n=0;p>n;n++)m(h[n],n,n);else for(var n=0;p>n;n++)for(o=h[n],e=0;l>e;e++)m(i.deepValue(o,c[e]),o,n);this.options.shouldSort&&u.sort(this.options.sortFn);for(var L=this.options.includeScore?function(t){return u[t]}:function(t){return u[t].item},S=this.options.id?function(t){return i.deepValue(L(t),options.id)}:function(t){return L(t)},n=0,g=u.length;g>n;n++)d.push(S(n));return d},"object"==typeof exports?module.exports=n:"function"==typeof define&&define.amd?define(function(){return n}):t.Fuse=n}(this);
      </script>
      <script>
        (function(){(function(a,b){if(typeof exports==="object"){module.exports=b(this)}else{if(typeof define==="function"&&define.amd){define(function(){return b(a)})}else{a.Fiber=b(a)}}}(this,function(c){var b=false,a=Array.prototype,d=c.Fiber;function f(i,h){var g;for(g in i){if(i.hasOwnProperty(g)){h[g]=i[g]}}}function e(){}e.extend=function(i){var h=this.prototype,g=i(h),j;function k(){if(!b){this.init.apply(this,arguments);this.init=void 0}}b=true;j=k.prototype=new this;b=false;j.init=function(){if(typeof h.init==="function"){h.init.apply(this,arguments)}};f(g,j);j.constructor=k;k.__base__=h;k.extend=k.prototype.extend||e.extend;return k};e.proxy=function(j,g){var h,k={},i;if(arguments.length===1){g=j;j=g.constructor.__base__}i=function(l){return function(){return j[l].apply(g,arguments)}};for(h in j){if(j.hasOwnProperty(h)&&typeof j[h]==="function"){k[h]=i(h)}}return k};e.decorate=function(h){var k,l=h.constructor.__base__,j=a.slice.call(arguments,1),g=j.length;for(k=0;k<g;k++){f(j[k].call(h,l),h)}};e.mixin=function(k){var j,l=k.__base__,h=a.slice.call(arguments,1),g=h.length;for(j=0;j<g;j++){f(h[j](l),k.prototype)}};e.noConflict=function(){c.Fiber=d;return e};return e}))}());
      </script>

      <script>
      </script>
  </head>

  <section id="items">
    <h2>Items</h2>

    <textarea rows="20" cols="100" id="itemsTextArea">
[
   {
      title: "Old Man's War",
      author: {
        firstName: "John",
        lastName: "Scalzi"
      }
   },
   {
      title: "The Lock Artist",
      author: {
        firstName: "Steve",
        lastName: "Hamilton"
      }
   },
   {
      title: "HTML5",
      author: {
        firstName: "Remy",
        lastName: "Sharp"
      }
   },
   {
      title: "Right Ho Jeeves",
      author: {
        firstName: "P.D",
        lastName: "Woodhouse"
      }
   },
   {
      title: "The Code of the Wooster",
      author: {
        firstName: "P.D",
        lastName: "Woodhouse"
      }
   },
   {
      title: "Thank You Jeeves",
      author: {
        firstName: "P.D",
        lastName: "Woodhouse"
      }
   },
   {
      title: "The DaVinci Code",
      author: {
        firstName: "Dan",
        lastName: "Brown"
      }
   },
   {
      title: "Angels & Demons",
      author: {
        firstName: "Dan",
        lastName: "Brown"
      }
   },
   {
      title: "The Silmarillion",
      author: {
        firstName: "J.R.R",
        lastName: "Tolkien"
      }
   },
   {
      title: "Syrup",
      author: {
        firstName: "Max",
        lastName: "Barry"
      }
   },
   {
      title: "The Lost Symbol",
      author: {
        firstName: "Dan",
        lastName: "Brown"
      }
   },
   {
      title: "The Book of Lies",
      author: {
        firstName: "Brad",
        lastName: "Meltzer"
      }
   },
   {
      title: "Lamb",
      author: {
        firstName: "Christopher",
        lastName: "Moore"
      }
   },
   {
      title: "Fool",
      author: {
        firstName: "Christopher",
        lastName: "Moore"
      }
   },
   {
      title: "Incompetence",
      author: {
        firstName: "Rob",
        lastName: "Grant"
      }
   },
   {
      title: "Fat",
      author: {
        firstName: "Rob",
        lastName: "Grant"
      }
   },
   {
      title: "Colony",
      author: {
        firstName: "Rob",
        lastName: "Grant"
      }
   },
   {
      title: "Backwards, Red Dwarf",
      author: {
        firstName: "Rob",
        lastName: "Grant"
      }
   },
   {
      title: "The Grand Design",
      author: {
        firstName: "Stephen",
        lastName: "Hawking"
      }
   },
   {
      title: "The Book of Samson",
      author: {
        firstName: "David",
        lastName: "Maine"
      }
   },
   {
      title: "The Preservationist",
      author: {
        firstName: "David",
        lastName: "Maine"
      }
   },
   {
      title: "Fallen",
      author: {
        firstName: "David",
        lastName: "Maine"
      }
   },
   {
      title: "Monster 1959",
      author: {
        firstName: "David",
        lastName: "Maine"
      }
   }
]
    </textarea>

  </section>

  <section id="options">

    <h2>Options</h2>

    <article>
      <input type="checkbox" id="caseSensitiveCheckbox" />
      <label for="caseSensitiveCheckbox">Case sensitive</label>
      <aside>
        Indicates whether comparisons should be case sensitive
      </aside>
    </article>

    <article>
      <input type="checkbox" id="scoreCheckbox" />
      <label for="scoreCheckbox">Include score</label>
      <aside>
        Whether the score should be included in the result set
      </aside>
    </article>

    <article>
      <input type="checkbox" id="sortCheckbox" checked="checked" />
      <label for="sortCheckbox">Sort</label>
      <aside>
        Whether to sort the result list, by score
      </aside>
    </article>

    <article>
      <label for="identifierTextbox">ID</label>
      <input type="text" id="identifierTextbox" />
      <aside>
        The name of the identifier property. If specified, the returned result will be a list of the items' identifiers, otherwise it will be a list of the items
      </aside>
    </article>

    <article>
      <label for="keysTextbox">Keys</label>
      <input type="text" id="keysTextbox" value="title,author.firstName" />
      <aside>
        List of properties that will be searched. This also supports nested properties
      </aside>
    </article>

    <article>
      <label for="locationRange">Location</label>
      <input type="number" id="locationRange" min="0" max="100" value="0">
      <aside>
        Determines approximately where in the text is the pattern expected to be found
      </aside>
    </article>

    <article>
      <label for="thresholdRange">Threshold</label>
      <input type="number" id="thresholdRange" min="0" step="0.1" max="1" value="0.6">
      <aside>
        At what point does the match algorithm give up. A threshold of 0.0 requires a perfect match (of both letters and location), a threshold of 1.0 would match anything
      </aside>
    </article>

    <article>
      <label for="distanceRange">Distance</label>
      <input type="number" id="distanceRange" min="0" max="1000" value="100">
      <aside>
        Determines how close the match must be to the fuzzy location (specified by location). An exact letter match which is distance characters away from the fuzzy location would score as a complete mismatch. A distance of 0 requires the match be at the exact location specified, a threshold of 1000 would require a perfect match to be within 800 characters of the location to be found using a threshold of 0.8.
      </aside>
    </article>

    <article>
      <label for="maxPatternLength">Max pattern length</label>
      <input type="number" id="maxPatternLength" min="0" max="64" value="32">
      <aside>
        The maximum length of the pattern. The longer the pattern, the more intensive the search operation will be. Whenever the pattern exceeds the maxPatternLength, an error will be thrown. Why is this important? Read this.
      </aside>
    </article>

  </section>

  <section id="js">
    <h2>JavaScript</h2>

    <pre>
<code id="jsTextArea"></code>
    </pre>

  </section>

  <section id="search">
    <h2>Search</h2>

    <input type="text" id="searchTextbox" />

  </section>

  <section id="output">
    <h2>Output</h2>

    <label>Search time:</label>
    <span id="searchTimeLabel"></span>

    <pre id="resultTextAreaContainer">
<code id="resultTextArea"></code>
    </pre>

  </section>

  <script>

    $(function (window) {

      // Mixins
      var Mixins = {};
      Mixins.Event = function (base) {
        return  {
          _hook: function () {
            if (!this._$hook) {
              this._$hook = $({});
            }
            return this._$hook;
          },
          on: function () {
            var hook = this._hook();
            hook.on.apply(hook, arguments);
          },
          off: function () {
            var hook = this._hook();
            hook.off.apply(hook, arguments);
          },
          trigger: function () {
            var hook = this._hook();
            hook.trigger.apply(hook, arguments);
          }
        };
      };

      // Core
      var App = {};

      App.Options = Fiber.extend(function() {
        return {
          init: function() {
            this.setupNodes();
            this.bindEvents();
            this.data = {};

            _.each(this.checkboxItems, _.bind(function(item) {
              this.setupCheckboxItems(item, false);
            }, this));

            _.each(this.rangeItems, _.bind(function(item) {
              this.setupRangeItems(item, false);
            }, this));

            this.setupKeys(false);

            this.setupPatternLength(false);
          },
          setupNodes: function() {
            this.$caseSensitiveCheckbox = $('#caseSensitiveCheckbox');
            this.$scoreCheckbox = $('#scoreCheckbox');
            this.$sortCheckbox = $('#sortCheckbox');
            this.$identifierTextbox = $('#identifierTextbox');
            this.$keysTextbox = $('#keysTextbox');
            this.$locationRange = $('#locationRange');
            this.$thresholdRange = $('#thresholdRange');
            this.$distanceRange = $('#distanceRange');
            this.$maxPatternLength = $('#maxPatternLength');

            this.checkboxItems = [{
              node: this.$caseSensitiveCheckbox,
              name: 'caseSensitive'
            }, {
              node: this.$scoreCheckbox,
              name: 'includeScore'
            }, {
              node: this.$sortCheckbox,
              name: 'shouldSort'
            }];

            this.rangeItems = [{
              node: this.$thresholdRange,
              name: 'threshold'
            }, {
              node: this.$locationRange,
              name: 'location'
            }, {
              node: this.$distanceRange,
              name: 'distance'
            }];
          },
          bindEvents: function() {
            // Checkboxes
            _.each(this.checkboxItems, _.bind(function(item) {
              item.node.on('change', _.bind(function() {
                this.setupCheckboxItems(item, true);
              }, this));
            }, this));

            // Ranges
            _.each(this.rangeItems, _.bind(function(item) {
              item.node.on('change', _.bind(function() {
                this.setupRangeItems(item, true);
              }, this));
            }, this));

            // keys
            this.$keysTextbox.on('change', _.bind(this.setupKeys, this));

            // Pattern length
            this.$maxPatternLength.on('change', _.bind(this.setupPatternLength, this));
          },
          setupCheckboxItems: function(item, trigger) {
            var checked = item.node.prop('checked');
            this.data[item.name] = checked;
            if (trigger || trigger === undefined) {
              this.trigger('change');
            }
          },
          setupRangeItems: function(item, trigger) {
            var value = item.node.val();
            this.data[item.name] = parseFloat(value);
            if (trigger || trigger === undefined) {
              this.trigger('change');
            }
          },
          setupKeys: function(trigger) {
            var text = this.$keysTextbox.val();
            var keys = text.split(',');
            keys = _.each(keys, function(key) {
              return key.trim();
            });
            this.data.keys = keys;
            if (trigger) {
              this.trigger('change');
            }
          },
          setupPatternLength: function(trigger) {
            var value = this.$maxPatternLength.val();
            this.data['maxPatternLength'] = parseInt(value);
            if (trigger || trigger === undefined) {
              this.trigger('change');
            }
          }
        }
      });
      Fiber.mixin(App.Options, Mixins.Event);

      App.Main = new (Fiber.extend(function() {
        return {
          init: function() {
            this.setupNodes();
            this.bindEvents();
            this.setupItems();
          },
          setupNodes: function() {
            this.$itemsTextArea = $('#itemsTextArea');
            this.$searchTextbox = $('#searchTextbox');
            this.$resultTextArea = $('#resultTextArea');
            this.$jsTextArea = $('#jsTextArea');
            this.$searchTimeLabel = $('#searchTimeLabel');
          },
          bindEvents: function() {
            this.options = new App.Options();
            this.options.on('change', _.bind(this.setupFuse, this));
            this.$itemsTextArea.on('change', _.bind(this.setupItems, this));

            this.$searchTextbox.on('keyup', _.debounce(_.bind(function() {
              this.search(this.$searchTextbox.val());
            }, this), 0));
          },
          setupItems: function() {
            var list = this.$itemsTextArea.val();
            this.list = eval(list);
            this.setupFuse();
          },
          setupFuse: function() {
            this.fuse = new Fuse(this.list, this.options.data);
            console.log(this.options.data);
            this.search(this.$searchTextbox.val());
          },
          search: function(pattern) {
            this.pattern = pattern;
            var start = new Date().getTime();
            var result = this.fuse.search(pattern);
            var end = new Date().getTime();
            this.$searchTimeLabel.text((end - start) + ' ms');
            this.$resultTextArea.html(JSON.stringify(result, null, '  '));
            this.updateJS();
          },
          updateJS: function() {
            var arr = [];
            arr.push('var options = {');
            arr.push('  caseSensitive: ' + this.options.data.caseSensitive + ',');
            arr.push('  includeScore: ' + this.options.data.includeScore + ',');
            arr.push('  shouldSort: ' + this.options.data.shouldSort + ',');
            arr.push('  threshold: ' + this.options.data.threshold + ',');
            arr.push('  location: ' + this.options.data.location + ',');
            arr.push('  distance: ' + this.options.data.distance + ',');
            arr.push('  maxPatternLength: ' + this.options.data.maxPatternLength + ',');
            var keys = _.map(this.options.data.keys, function(item) {
              return '"' + item + '"'
            }).join(',');
            arr.push('  keys: [' + keys + ']');
            arr.push('};');
            arr.push('var fuse = new Fuse(list, options);');
            arr.push('var result = fuse.search("' + this.pattern + '");');
            arr = arr.join('\n');
            this.$jsTextArea.html(arr);
          }
        }
      }))();

    });

  </script>

</body>

</html>
